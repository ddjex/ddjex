{
  "$ddjex": "0.4.0",
  "id": "auth-forgot-password",
  "target": "dom",

  "state": {
    "step": { "type": "string", "initial": "email" },
    "email": { "type": "string", "initial": "" },
    "code": { "type": "string", "initial": "" },
    "newPassword": { "type": "string", "initial": "" },
    "confirmPassword": { "type": "string", "initial": "" },
    "loading": { "type": "boolean", "initial": false },
    "error": { "type": "string", "initial": "" },
    "resendCooldown": { "type": "number", "initial": 0 }
  },

  "computed": {
    "emailValid": {
      "deps": ["email"],
      "fn": { "op": "isEmail", "args": [{ "ref": "email" }] }
    },
    "codeValid": {
      "deps": ["code"],
      "fn": { "op": "eq", "args": [{ "op": "length", "args": [{ "ref": "code" }] }, 6] }
    },
    "passwordValid": {
      "deps": ["newPassword"],
      "fn": { "op": "hasMinLength", "args": [{ "ref": "newPassword" }, 8] }
    },
    "passwordsMatch": {
      "deps": ["newPassword", "confirmPassword"],
      "fn": { "op": "eq", "args": [{ "ref": "newPassword" }, { "ref": "confirmPassword" }] }
    },
    "canSubmitEmail": {
      "deps": ["emailValid", "loading"],
      "fn": { "op": "and", "args": [{ "ref": "emailValid" }, { "op": "not", "args": [{ "ref": "loading" }] }] }
    },
    "canSubmitCode": {
      "deps": ["codeValid", "loading"],
      "fn": { "op": "and", "args": [{ "ref": "codeValid" }, { "op": "not", "args": [{ "ref": "loading" }] }] }
    },
    "canSubmitPassword": {
      "deps": ["passwordValid", "passwordsMatch", "loading"],
      "fn": {
        "op": "and",
        "args": [
          { "ref": "passwordValid" },
          { "ref": "passwordsMatch" },
          { "op": "not", "args": [{ "ref": "loading" }] }
        ]
      }
    },
    "canResend": {
      "deps": ["resendCooldown"],
      "fn": { "op": "eq", "args": [{ "ref": "resendCooldown" }, 0] }
    },
    "isEmailStep": {
      "deps": ["step"],
      "fn": { "op": "eq", "args": [{ "ref": "step" }, "email"] }
    },
    "isCodeStep": {
      "deps": ["step"],
      "fn": { "op": "eq", "args": [{ "ref": "step" }, "code"] }
    },
    "isPasswordStep": {
      "deps": ["step"],
      "fn": { "op": "eq", "args": [{ "ref": "step" }, "password"] }
    },
    "isSuccessStep": {
      "deps": ["step"],
      "fn": { "op": "eq", "args": [{ "ref": "step" }, "success"] }
    }
  },

  "actions": {
    "setEmail": {
      "params": ["value"],
      "mutations": [
        { "target": "email", "op": "set", "value": { "param": "value" } },
        { "target": "error", "op": "set", "value": "" }
      ]
    },
    "setCode": {
      "params": ["value"],
      "mutations": [
        { "target": "code", "op": "set", "value": { "param": "value" } },
        { "target": "error", "op": "set", "value": "" }
      ]
    },
    "setNewPassword": {
      "params": ["value"],
      "mutations": [{ "target": "newPassword", "op": "set", "value": { "param": "value" } }]
    },
    "setConfirmPassword": {
      "params": ["value"],
      "mutations": [{ "target": "confirmPassword", "op": "set", "value": { "param": "value" } }]
    },
    "submitEmail": {
      "mutations": [
        { "target": "loading", "op": "set", "value": true }
      ]
    },
    "emailSent": {
      "mutations": [
        { "target": "loading", "op": "set", "value": false },
        { "target": "step", "op": "set", "value": "code" },
        { "target": "resendCooldown", "op": "set", "value": 60 }
      ]
    },
    "submitCode": {
      "mutations": [
        { "target": "loading", "op": "set", "value": true }
      ]
    },
    "codeVerified": {
      "mutations": [
        { "target": "loading", "op": "set", "value": false },
        { "target": "step", "op": "set", "value": "password" }
      ]
    },
    "submitPassword": {
      "mutations": [
        { "target": "loading", "op": "set", "value": true }
      ]
    },
    "passwordReset": {
      "mutations": [
        { "target": "loading", "op": "set", "value": false },
        { "target": "step", "op": "set", "value": "success" }
      ]
    },
    "setError": {
      "params": ["message"],
      "mutations": [
        { "target": "loading", "op": "set", "value": false },
        { "target": "error", "op": "set", "value": { "param": "message" } }
      ]
    },
    "resendCode": {
      "mutations": [
        { "target": "resendCooldown", "op": "set", "value": 60 }
      ]
    },
    "decrementCooldown": {
      "mutations": [
        {
          "target": "resendCooldown",
          "op": "set",
          "value": { "op": "max", "args": [0, { "op": "subtract", "args": [{ "ref": "resendCooldown" }, 1] }] }
        }
      ]
    },
    "goBack": {
      "mutations": [
        {
          "target": "step",
          "op": "set",
          "value": {
            "op": "switch",
            "args": [
              { "ref": "step" },
              { "code": "email", "password": "code" },
              "email"
            ]
          }
        },
        { "target": "error", "op": "set", "value": "" }
      ]
    }
  },

  "effects": [
    {
      "id": "cooldown-timer",
      "trigger": { "type": "interval", "interval": 1000 },
      "condition": { "op": "gt", "args": [{ "ref": "resendCooldown" }, 0] },
      "do": { "action": "decrementCooldown" }
    }
  ],

  "root": {
    "type": "div",
    "props": { "className": "min-h-screen flex items-center justify-center bg-gray-100 p-4" },
    "children": [
      {
        "type": "div",
        "props": { "className": "bg-white p-8 rounded-lg shadow-md w-full max-w-md" },
        "children": [
          {
            "type": "div",
            "props": { "className": "flex justify-center mb-6" },
            "children": [
              {
                "type": "div",
                "props": { "className": "flex items-center" },
                "children": [
                  {
                    "type": "div",
                    "props": {
                      "className": {
                        "op": "if",
                        "args": [
                          { "ref": "isEmailStep" },
                          "w-10 h-10 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold",
                          "w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center"
                        ]
                      }
                    },
                    "children": [{ "op": "if", "args": [{ "ref": "isEmailStep" }, "1", "✓"] }]
                  },
                  { "type": "div", "props": { "className": "w-12 h-1 bg-gray-300" } },
                  {
                    "type": "div",
                    "props": {
                      "className": {
                        "op": "switch",
                        "args": [
                          { "ref": "step" },
                          {
                            "email": "w-10 h-10 rounded-full bg-gray-300 text-gray-500 flex items-center justify-center font-bold",
                            "code": "w-10 h-10 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold"
                          },
                          "w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center"
                        ]
                      }
                    },
                    "children": [{ "op": "if", "args": [{ "op": "or", "args": [{ "ref": "isPasswordStep" }, { "ref": "isSuccessStep" }] }, "✓", "2"] }]
                  },
                  { "type": "div", "props": { "className": "w-12 h-1 bg-gray-300" } },
                  {
                    "type": "div",
                    "props": {
                      "className": {
                        "op": "if",
                        "args": [
                          { "ref": "isSuccessStep" },
                          "w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center",
                          {
                            "op": "if",
                            "args": [
                              { "ref": "isPasswordStep" },
                              "w-10 h-10 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold",
                              "w-10 h-10 rounded-full bg-gray-300 text-gray-500 flex items-center justify-center font-bold"
                            ]
                          }
                        ]
                      }
                    },
                    "children": [{ "op": "if", "args": [{ "ref": "isSuccessStep" }, "✓", "3"] }]
                  }
                ]
              }
            ]
          },
          {
            "if": { "op": "isNotEmpty", "args": [{ "ref": "error" }] },
            "then": {
              "type": "div",
              "props": { "className": "bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4" },
              "children": [{ "bind": "error" }]
            }
          },
          {
            "if": { "ref": "isEmailStep" },
            "then": {
              "type": "div",
              "children": [
                { "type": "h2", "props": { "className": "text-2xl font-bold mb-2 text-center" }, "children": [{ "text": "Forgot Password?" }] },
                { "type": "p", "props": { "className": "text-gray-600 text-center mb-6" }, "children": [{ "text": "Enter your email and we'll send you a reset code." }] },
                {
                  "type": "div",
                  "props": { "className": "mb-4" },
                  "children": [
                    { "type": "label", "props": { "className": "block text-gray-700 mb-2" }, "children": [{ "text": "Email Address" }] },
                    {
                      "type": "input",
                      "props": {
                        "type": "email",
                        "className": "w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500",
                        "placeholder": "you@example.com",
                        "value": { "ref": "email" }
                      },
                      "events": { "input": { "action": "setEmail", "args": [{ "op": "eventValue" }] } }
                    }
                  ]
                },
                {
                  "type": "button",
                  "props": {
                    "className": {
                      "op": "if",
                      "args": [
                        { "ref": "canSubmitEmail" },
                        "w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600",
                        "w-full bg-gray-300 text-gray-500 py-2 rounded cursor-not-allowed"
                      ]
                    },
                    "disabled": { "op": "not", "args": [{ "ref": "canSubmitEmail" }] }
                  },
                  "events": { "click": { "action": "submitEmail" } },
                  "children": [
                    { "op": "if", "args": [{ "ref": "loading" }, "Sending...", "Send Reset Code"] }
                  ]
                }
              ]
            }
          },
          {
            "if": { "ref": "isCodeStep" },
            "then": {
              "type": "div",
              "children": [
                { "type": "h2", "props": { "className": "text-2xl font-bold mb-2 text-center" }, "children": [{ "text": "Check Your Email" }] },
                {
                  "type": "p",
                  "props": { "className": "text-gray-600 text-center mb-6" },
                  "children": [{ "text": "We sent a 6-digit code to " }, { "bind": "email" }]
                },
                {
                  "type": "div",
                  "props": { "className": "mb-4" },
                  "children": [
                    { "type": "label", "props": { "className": "block text-gray-700 mb-2" }, "children": [{ "text": "Verification Code" }] },
                    {
                      "type": "input",
                      "props": {
                        "type": "text",
                        "className": "w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 text-center text-2xl tracking-widest",
                        "placeholder": "000000",
                        "maxLength": 6,
                        "value": { "ref": "code" }
                      },
                      "events": { "input": { "action": "setCode", "args": [{ "op": "eventValue" }] } }
                    }
                  ]
                },
                {
                  "type": "button",
                  "props": {
                    "className": {
                      "op": "if",
                      "args": [
                        { "ref": "canSubmitCode" },
                        "w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600 mb-4",
                        "w-full bg-gray-300 text-gray-500 py-2 rounded cursor-not-allowed mb-4"
                      ]
                    },
                    "disabled": { "op": "not", "args": [{ "ref": "canSubmitCode" }] }
                  },
                  "events": { "click": { "action": "submitCode" } },
                  "children": [
                    { "op": "if", "args": [{ "ref": "loading" }, "Verifying...", "Verify Code"] }
                  ]
                },
                {
                  "type": "div",
                  "props": { "className": "text-center" },
                  "children": [
                    {
                      "if": { "ref": "canResend" },
                      "then": {
                        "type": "button",
                        "props": { "className": "text-blue-500 hover:underline" },
                        "events": { "click": { "action": "resendCode" } },
                        "children": [{ "text": "Resend code" }]
                      },
                      "else": {
                        "type": "span",
                        "props": { "className": "text-gray-500" },
                        "children": [{ "text": "Resend in " }, { "bind": "resendCooldown" }, { "text": "s" }]
                      }
                    }
                  ]
                }
              ]
            }
          },
          {
            "if": { "ref": "isPasswordStep" },
            "then": {
              "type": "div",
              "children": [
                { "type": "h2", "props": { "className": "text-2xl font-bold mb-2 text-center" }, "children": [{ "text": "Reset Password" }] },
                { "type": "p", "props": { "className": "text-gray-600 text-center mb-6" }, "children": [{ "text": "Enter your new password below." }] },
                {
                  "type": "div",
                  "props": { "className": "mb-4" },
                  "children": [
                    { "type": "label", "props": { "className": "block text-gray-700 mb-2" }, "children": [{ "text": "New Password" }] },
                    {
                      "type": "input",
                      "props": {
                        "type": "password",
                        "className": "w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500",
                        "placeholder": "At least 8 characters",
                        "value": { "ref": "newPassword" }
                      },
                      "events": { "input": { "action": "setNewPassword", "args": [{ "op": "eventValue" }] } }
                    }
                  ]
                },
                {
                  "type": "div",
                  "props": { "className": "mb-4" },
                  "children": [
                    { "type": "label", "props": { "className": "block text-gray-700 mb-2" }, "children": [{ "text": "Confirm Password" }] },
                    {
                      "type": "input",
                      "props": {
                        "type": "password",
                        "className": "w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500",
                        "placeholder": "Repeat your password",
                        "value": { "ref": "confirmPassword" }
                      },
                      "events": { "input": { "action": "setConfirmPassword", "args": [{ "op": "eventValue" }] } }
                    },
                    {
                      "if": { "op": "and", "args": [{ "op": "isNotEmpty", "args": [{ "ref": "confirmPassword" }] }, { "op": "not", "args": [{ "ref": "passwordsMatch" }] }] },
                      "then": {
                        "type": "p",
                        "props": { "className": "text-red-500 text-sm mt-1" },
                        "children": [{ "text": "Passwords do not match" }]
                      }
                    }
                  ]
                },
                {
                  "type": "button",
                  "props": {
                    "className": {
                      "op": "if",
                      "args": [
                        { "ref": "canSubmitPassword" },
                        "w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600",
                        "w-full bg-gray-300 text-gray-500 py-2 rounded cursor-not-allowed"
                      ]
                    },
                    "disabled": { "op": "not", "args": [{ "ref": "canSubmitPassword" }] }
                  },
                  "events": { "click": { "action": "submitPassword" } },
                  "children": [
                    { "op": "if", "args": [{ "ref": "loading" }, "Resetting...", "Reset Password"] }
                  ]
                }
              ]
            }
          },
          {
            "if": { "ref": "isSuccessStep" },
            "then": {
              "type": "div",
              "props": { "className": "text-center" },
              "children": [
                { "type": "div", "props": { "className": "text-green-500 text-5xl mb-4" }, "children": [{ "text": "✓" }] },
                { "type": "h2", "props": { "className": "text-2xl font-bold mb-2" }, "children": [{ "text": "Password Reset!" }] },
                { "type": "p", "props": { "className": "text-gray-600 mb-6" }, "children": [{ "text": "Your password has been successfully reset. You can now sign in with your new password." }] },
                {
                  "type": "a",
                  "props": { "href": "#", "className": "inline-block bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600" },
                  "children": [{ "text": "Sign In" }]
                }
              ]
            }
          },
          {
            "if": { "op": "not", "args": [{ "op": "or", "args": [{ "ref": "isEmailStep" }, { "ref": "isSuccessStep" }] }] },
            "then": {
              "type": "button",
              "props": { "className": "mt-4 text-gray-500 hover:text-gray-700 text-sm" },
              "events": { "click": { "action": "goBack" } },
              "children": [{ "text": "← Back" }]
            }
          }
        ]
      }
    ]
  },

  "tests": [
    {
      "id": "test-initial-state",
      "name": "Starts at email step",
      "steps": [
        { "assert": { "ref": "step", "eq": "email" } },
        { "assert": { "ref": "isEmailStep", "eq": true } }
      ]
    },
    {
      "id": "test-email-validation",
      "name": "Email validation works",
      "steps": [
        { "dispatch": "setEmail", "args": ["invalid"] },
        { "assert": { "ref": "emailValid", "eq": false } },
        { "dispatch": "setEmail", "args": ["test@example.com"] },
        { "assert": { "ref": "emailValid", "eq": true } }
      ]
    },
    {
      "id": "test-step-progression",
      "name": "Steps progress correctly",
      "steps": [
        { "dispatch": "emailSent" },
        { "assert": { "ref": "step", "eq": "code" } },
        { "dispatch": "codeVerified" },
        { "assert": { "ref": "step", "eq": "password" } },
        { "dispatch": "passwordReset" },
        { "assert": { "ref": "step", "eq": "success" } }
      ]
    },
    {
      "id": "test-code-validation",
      "name": "Code must be 6 digits",
      "steps": [
        { "dispatch": "setCode", "args": ["12345"] },
        { "assert": { "ref": "codeValid", "eq": false } },
        { "dispatch": "setCode", "args": ["123456"] },
        { "assert": { "ref": "codeValid", "eq": true } }
      ]
    },
    {
      "id": "test-password-match",
      "name": "Passwords must match",
      "steps": [
        { "dispatch": "setNewPassword", "args": ["Password123"] },
        { "dispatch": "setConfirmPassword", "args": ["Password124"] },
        { "assert": { "ref": "passwordsMatch", "eq": false } },
        { "dispatch": "setConfirmPassword", "args": ["Password123"] },
        { "assert": { "ref": "passwordsMatch", "eq": true } }
      ]
    },
    {
      "id": "test-go-back",
      "name": "Can go back through steps",
      "steps": [
        { "dispatch": "emailSent" },
        { "dispatch": "codeVerified" },
        { "assert": { "ref": "step", "eq": "password" } },
        { "dispatch": "goBack" },
        { "assert": { "ref": "step", "eq": "code" } },
        { "dispatch": "goBack" },
        { "assert": { "ref": "step", "eq": "email" } }
      ]
    }
  ]
}
