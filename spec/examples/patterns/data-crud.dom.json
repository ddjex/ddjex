{
  "$ddjex": "0.4.0",
  "id": "data-crud",
  "target": "dom",

  "state": {
    "users": {
      "type": "array",
      "initial": [
        { "id": 1, "name": "Alice Johnson", "email": "alice@example.com", "role": "admin" },
        { "id": 2, "name": "Bob Smith", "email": "bob@example.com", "role": "user" },
        { "id": 3, "name": "Carol White", "email": "carol@example.com", "role": "user" }
      ]
    },
    "editingId": { "type": "number", "initial": null, "nullable": true },
    "formName": { "type": "string", "initial": "" },
    "formEmail": { "type": "string", "initial": "" },
    "formRole": { "type": "string", "initial": "user" },
    "nextId": { "type": "number", "initial": 4 },
    "deleteConfirmId": { "type": "number", "initial": null, "nullable": true }
  },

  "computed": {
    "isEditing": {
      "deps": ["editingId"],
      "fn": { "op": "isDefined", "args": [{ "ref": "editingId" }] }
    },
    "isFormValid": {
      "deps": ["formName", "formEmail"],
      "fn": {
        "op": "and",
        "args": [
          { "op": "hasMinLength", "args": [{ "ref": "formName" }, 1] },
          { "op": "isEmail", "args": [{ "ref": "formEmail" }] }
        ]
      }
    },
    "userCount": {
      "deps": ["users"],
      "fn": { "op": "length", "args": [{ "ref": "users" }] }
    }
  },

  "actions": {
    "setFormName": {
      "params": ["value"],
      "mutations": [{ "target": "formName", "op": "set", "value": { "param": "value" } }]
    },
    "setFormEmail": {
      "params": ["value"],
      "mutations": [{ "target": "formEmail", "op": "set", "value": { "param": "value" } }]
    },
    "setFormRole": {
      "params": ["value"],
      "mutations": [{ "target": "formRole", "op": "set", "value": { "param": "value" } }]
    },
    "createUser": {
      "mutations": [
        {
          "target": "users",
          "op": "push",
          "value": {
            "id": { "ref": "nextId" },
            "name": { "ref": "formName" },
            "email": { "ref": "formEmail" },
            "role": { "ref": "formRole" }
          }
        },
        { "target": "nextId", "op": "add", "value": 1 },
        { "target": "formName", "op": "set", "value": "" },
        { "target": "formEmail", "op": "set", "value": "" },
        { "target": "formRole", "op": "set", "value": "user" }
      ]
    },
    "startEdit": {
      "params": ["user"],
      "mutations": [
        { "target": "editingId", "op": "set", "value": { "op": "get", "args": [{ "param": "user" }, "id"] } },
        { "target": "formName", "op": "set", "value": { "op": "get", "args": [{ "param": "user" }, "name"] } },
        { "target": "formEmail", "op": "set", "value": { "op": "get", "args": [{ "param": "user" }, "email"] } },
        { "target": "formRole", "op": "set", "value": { "op": "get", "args": [{ "param": "user" }, "role"] } }
      ]
    },
    "updateUser": {
      "mutations": [
        {
          "target": "users",
          "op": "set",
          "value": {
            "op": "map",
            "args": [
              { "ref": "users" },
              {
                "op": "if",
                "args": [
                  { "op": "eq", "args": [{ "op": "get", "args": [{ "ref": "$item" }, "id"] }, { "ref": "editingId" }] },
                  {
                    "op": "merge",
                    "args": [
                      { "ref": "$item" },
                      { "name": { "ref": "formName" }, "email": { "ref": "formEmail" }, "role": { "ref": "formRole" } }
                    ]
                  },
                  { "ref": "$item" }
                ]
              }
            ]
          }
        },
        { "target": "editingId", "op": "set", "value": null },
        { "target": "formName", "op": "set", "value": "" },
        { "target": "formEmail", "op": "set", "value": "" },
        { "target": "formRole", "op": "set", "value": "user" }
      ]
    },
    "cancelEdit": {
      "mutations": [
        { "target": "editingId", "op": "set", "value": null },
        { "target": "formName", "op": "set", "value": "" },
        { "target": "formEmail", "op": "set", "value": "" },
        { "target": "formRole", "op": "set", "value": "user" }
      ]
    },
    "confirmDelete": {
      "params": ["id"],
      "mutations": [{ "target": "deleteConfirmId", "op": "set", "value": { "param": "id" } }]
    },
    "cancelDelete": {
      "mutations": [{ "target": "deleteConfirmId", "op": "set", "value": null }]
    },
    "deleteUser": {
      "mutations": [
        {
          "target": "users",
          "op": "set",
          "value": { "op": "filter", "args": [{ "ref": "users" }, { "op": "neq", "args": [{ "op": "get", "args": [{ "ref": "$item" }, "id"] }, { "ref": "deleteConfirmId" }] }] }
        },
        { "target": "deleteConfirmId", "op": "set", "value": null }
      ]
    }
  },

  "root": {
    "type": "div",
    "props": { "className": "max-w-4xl mx-auto p-6" },
    "children": [
      { "type": "h1", "props": { "className": "text-2xl font-bold mb-6" }, "children": [{ "text": "User Management (CRUD)" }] },
      {
        "type": "div",
        "props": { "className": "bg-white rounded-lg shadow-md p-6 mb-6" },
        "children": [
          {
            "type": "h2",
            "props": { "className": "text-lg font-semibold mb-4" },
            "children": [{ "op": "if", "args": [{ "ref": "isEditing" }, "Edit User", "Add New User"] }]
          },
          {
            "type": "div",
            "props": { "className": "grid grid-cols-1 md:grid-cols-4 gap-4" },
            "children": [
              {
                "type": "input",
                "props": {
                  "type": "text",
                  "placeholder": "Name",
                  "className": "px-3 py-2 border rounded",
                  "value": { "ref": "formName" }
                },
                "events": { "input": { "action": "setFormName", "args": [{ "op": "eventValue" }] } }
              },
              {
                "type": "input",
                "props": {
                  "type": "email",
                  "placeholder": "Email",
                  "className": "px-3 py-2 border rounded",
                  "value": { "ref": "formEmail" }
                },
                "events": { "input": { "action": "setFormEmail", "args": [{ "op": "eventValue" }] } }
              },
              {
                "type": "select",
                "props": { "className": "px-3 py-2 border rounded", "value": { "ref": "formRole" } },
                "events": { "change": { "action": "setFormRole", "args": [{ "op": "eventValue" }] } },
                "children": [
                  { "type": "option", "props": { "value": "user" }, "children": [{ "text": "User" }] },
                  { "type": "option", "props": { "value": "admin" }, "children": [{ "text": "Admin" }] }
                ]
              },
              {
                "type": "div",
                "props": { "className": "flex gap-2" },
                "children": [
                  {
                    "type": "button",
                    "props": {
                      "className": {
                        "op": "if",
                        "args": [
                          { "ref": "isFormValid" },
                          "flex-1 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600",
                          "flex-1 px-4 py-2 bg-gray-300 text-gray-500 rounded cursor-not-allowed"
                        ]
                      },
                      "disabled": { "op": "not", "args": [{ "ref": "isFormValid" }] }
                    },
                    "events": {
                      "click": {
                        "op": "if",
                        "args": [{ "ref": "isEditing" }, { "action": "updateUser" }, { "action": "createUser" }]
                      }
                    },
                    "children": [{ "op": "if", "args": [{ "ref": "isEditing" }, "Update", "Add"] }]
                  },
                  {
                    "if": { "ref": "isEditing" },
                    "then": {
                      "type": "button",
                      "props": { "className": "px-4 py-2 bg-gray-200 rounded hover:bg-gray-300" },
                      "events": { "click": { "action": "cancelEdit" } },
                      "children": [{ "text": "Cancel" }]
                    }
                  }
                ]
              }
            ]
          }
        ]
      },
      {
        "type": "div",
        "props": { "className": "bg-white rounded-lg shadow-md overflow-hidden" },
        "children": [
          {
            "type": "table",
            "props": { "className": "w-full" },
            "children": [
              {
                "type": "thead",
                "props": { "className": "bg-gray-50" },
                "children": [
                  {
                    "type": "tr",
                    "children": [
                      { "type": "th", "props": { "className": "px-4 py-3 text-left" }, "children": [{ "text": "Name" }] },
                      { "type": "th", "props": { "className": "px-4 py-3 text-left" }, "children": [{ "text": "Email" }] },
                      { "type": "th", "props": { "className": "px-4 py-3 text-left" }, "children": [{ "text": "Role" }] },
                      { "type": "th", "props": { "className": "px-4 py-3 text-right" }, "children": [{ "text": "Actions" }] }
                    ]
                  }
                ]
              },
              {
                "type": "tbody",
                "props": { "className": "divide-y" },
                "each": { "items": "users", "as": "user", "key": { "op": "get", "args": [{ "ref": "user" }, "id"] } },
                "children": [
                  {
                    "type": "tr",
                    "props": { "className": "hover:bg-gray-50" },
                    "children": [
                      { "type": "td", "props": { "className": "px-4 py-3 font-medium" }, "children": [{ "bind": "user.name" }] },
                      { "type": "td", "props": { "className": "px-4 py-3 text-gray-600" }, "children": [{ "bind": "user.email" }] },
                      {
                        "type": "td",
                        "props": { "className": "px-4 py-3" },
                        "children": [
                          {
                            "type": "span",
                            "props": {
                              "className": {
                                "op": "if",
                                "args": [
                                  { "op": "eq", "args": [{ "op": "get", "args": [{ "ref": "user" }, "role"] }, "admin"] },
                                  "px-2 py-1 bg-purple-100 text-purple-700 rounded text-sm",
                                  "px-2 py-1 bg-gray-100 text-gray-700 rounded text-sm"
                                ]
                              }
                            },
                            "children": [{ "bind": "user.role" }]
                          }
                        ]
                      },
                      {
                        "type": "td",
                        "props": { "className": "px-4 py-3 text-right" },
                        "children": [
                          {
                            "type": "button",
                            "props": { "className": "text-blue-500 hover:text-blue-700 mr-3" },
                            "events": { "click": { "action": "startEdit", "args": [{ "ref": "user" }] } },
                            "children": [{ "text": "Edit" }]
                          },
                          {
                            "type": "button",
                            "props": { "className": "text-red-500 hover:text-red-700" },
                            "events": { "click": { "action": "confirmDelete", "args": [{ "op": "get", "args": [{ "ref": "user" }, "id"] }] } },
                            "children": [{ "text": "Delete" }]
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          }
        ]
      },
      {
        "type": "p",
        "props": { "className": "mt-4 text-sm text-gray-500 text-center" },
        "children": [{ "text": "Total users: " }, { "bind": "userCount" }]
      },
      {
        "if": { "ref": "deleteConfirmId" },
        "then": {
          "portal": {
            "target": "body",
            "children": [
              {
                "type": "div",
                "props": { "className": "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" },
                "children": [
                  {
                    "type": "div",
                    "props": { "className": "bg-white rounded-lg p-6 max-w-sm w-full mx-4" },
                    "children": [
                      { "type": "h3", "props": { "className": "text-lg font-semibold mb-2" }, "children": [{ "text": "Confirm Delete" }] },
                      { "type": "p", "props": { "className": "text-gray-600 mb-4" }, "children": [{ "text": "Are you sure you want to delete this user?" }] },
                      {
                        "type": "div",
                        "props": { "className": "flex justify-end gap-2" },
                        "children": [
                          {
                            "type": "button",
                            "props": { "className": "px-4 py-2 bg-gray-200 rounded hover:bg-gray-300" },
                            "events": { "click": { "action": "cancelDelete" } },
                            "children": [{ "text": "Cancel" }]
                          },
                          {
                            "type": "button",
                            "props": { "className": "px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600" },
                            "events": { "click": { "action": "deleteUser" } },
                            "children": [{ "text": "Delete" }]
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          }
        }
      }
    ]
  },

  "tests": [
    {
      "id": "test-initial-users",
      "name": "Has initial users",
      "steps": [
        { "assert": { "ref": "userCount", "eq": 3 } }
      ]
    },
    {
      "id": "test-create-user",
      "name": "Can create a user",
      "steps": [
        { "dispatch": "setFormName", "args": ["New User"] },
        { "dispatch": "setFormEmail", "args": ["new@example.com"] },
        { "dispatch": "createUser" },
        { "assert": { "ref": "userCount", "eq": 4 } }
      ]
    },
    {
      "id": "test-delete-user",
      "name": "Can delete a user",
      "steps": [
        { "dispatch": "confirmDelete", "args": [1] },
        { "dispatch": "deleteUser" },
        { "assert": { "ref": "userCount", "eq": 2 } }
      ]
    }
  ]
}
